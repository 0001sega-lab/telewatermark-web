<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Сжатие до 720p + водяной знак</title>
  <style>
    :root { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    body { margin:0; background:#0b0c10; color:#e6e6e6; }
    header { padding:16px; text-align:center; background:#111217; }
    h1 { margin:0; font-size:18px; }
    main { padding:16px; max-width:680px; margin:0 auto; }
    .filepick input { display:none; }
    .filepick span { display:inline-block; background:#1f6feb; color:#fff; padding:12px 16px; border-radius:8px; font-weight:600; cursor:pointer; }
    .row { margin:12px 0; display:flex; gap:8px; align-items:center; }
    .row input[type=text]{ flex:1; padding:10px 12px; border-radius:8px; border:1px solid #2a2b32; background:#17181f; color:#fff; }
    .row button { padding:12px 16px; border:0; border-radius:8px; background:#30a46c; color:#0b0c10; font-weight:700; cursor:pointer; }
    .row button[disabled]{ opacity:.5; cursor:not-allowed; }
    .log { margin-top:12px; white-space:pre-wrap; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; background:#0f1115; border:1px solid #252733; padding:10px; border-radius:8px; min-height:80px; }
    .error { margin-top:8px; color:#ff7b72; font-size:13px; }
    .download { display:inline-block; margin-top:12px; background:#1f6feb; color:#fff; padding:12px 16px; border-radius:8px; text-decoration:none; }
    .hint { opacity:.8; font-size:13px; }
  </style>
</head>
<body>
  <header><h1>Сжать видео до 720p + водяной знак</h1></header>
  <main>
    <label class="filepick">
      <input id="file" type="file" accept="video/*" capture="environment" />
      <span>Выбрать видео</span>
    </label>

    <div class="row">
      <label>Текст водяного знака</label>
      <input id="wmText" type="text" placeholder="@yourbrand" value="@yourbrand" />
    </div>

    <div class="row">
      <button id="go" disabled>Начать обработку</button>
    </div>

    <div id="progress" class="log"></div>
    <a id="dl" class="download" download="output_720p_watermarked.mp4" style="display:none">Скачать готовый MP4</a>
    <p class="hint">Работает прямо в браузере телефона (Telegram WebApp). Длинные ролики требуют больше времени/памяти.</p>
    <div id="err" class="error"></div>
  </main>

  <!-- UMD-версия ffmpeg.wasm (без ES-модулей) -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/umd/ffmpeg.js"></script>
  <script>
    (function(){
      const $file = document.getElementById('file');
      const $go   = document.getElementById('go');
      const $dl   = document.getElementById('dl');
      const $log  = document.getElementById('progress');
      const $wm   = document.getElementById('wmText');
      const $err  = document.getElementById('err');

      // Берём API из глобального объекта FFmpeg (UMD)
      const { createFFmpeg, fetchFile } = window.FFmpeg;

      // Используем single-thread ядро (без SharedArrayBuffer/COOP/COEP)
      const ffmpeg = createFFmpeg({
        corePath: 'https://unpkg.com/@ffmpeg/core-st@0.12.6/dist/ffmpeg-core.js',
        log: true,
        progress: ({ ratio }) => {
          const pct = Math.max(0, Math.min(1, ratio || 0)) * 100;
          setLog('Обработка: ' + pct.toFixed(1) + '%');
        },
      });

      function setLog(t){ $log.textContent = t || ''; }
      function setErr(t){ $err.textContent = t || ''; }

      // Покажем любые ошибки прямо на странице
      window.addEventListener('error', e => setErr('JS error: ' + (e.message || e)));
      window.addEventListener('unhandledrejection', e => setErr('Promise rejected: ' + (e.reason?.message || e.reason || 'unknown')));

      // Подставим watermark из URL (?wm=...), если открыт через бота с параметром
      try {
        const sp = new URLSearchParams(location.search);
        const wm = sp.get('wm');
        if (wm) $wm.value = wm;
      } catch (e) {}

      $file.addEventListener('change', () => {
        $go.disabled = !$file.files?.length;
        $dl.style.display = 'none';
        setErr('');
        setLog($file.files?.length ? 'Файл выбран. Готов к обработке.' : '');
      });

      $go.addEventListener('click', async () => {
        try {
          const file = $file.files?.[0];
          if (!file) return alert('Выберите видео');
          $go.disabled = true; setLog('Загрузка модуля…'); setErr('');

          if (!ffmpeg.isLoaded()) {
            await ffmpeg.load();
            // Шрифт загрузим с CDN (CORS-совместим)
            const fontResp = await fetch('https://cdn.jsdelivr.net/gh/dejavu-fonts/dejavu-fonts@version_2_37/ttf/DejaVuSans-Bold.ttf');
            if (!fontResp.ok) throw new Error('Не удалось загрузить шрифт');
            const fontBuf = await fontResp.arrayBuffer();
            await ffmpeg.FS('writeFile', 'font.ttf', new Uint8Array(fontBuf));
          }

          setLog('Чтение видео…');
          await ffmpeg.FS('writeFile', 'in.mp4', await fetchFile(file));

          const text = ($wm.value || '@yourbrand').replace(/:/g,'\\:').replace(/'/g,"\\'");
          const DRAW =
            "drawtext=fontfile='font.ttf':" +
            "text='" + text + "':fontsize=28:fontcolor=white:alpha=0.65:" +
            "borderw=3:bordercolor=black@0.7:" +
            "x='if(eq(floor(mod(t/3,4)),0),10,if(eq(floor(mod(t/3,4)),1),W-tw-10,if(eq(floor(mod(t/3,4)),2),(W-tw)/2,W-tw-10)))':" +
            "y='if(eq(floor(mod(t/3,4)),0),10,if(eq(floor(mod(t/3,4)),1),H-th-10,if(eq(floor(mod(t/3,4)),2),(H-th)/2,H-th-10)))'";

          const vf =
            "scale='min(1280,iw)':'-2':flags=bicubic," +
            "pad=1280:720:(1280-iw*min(1280/iw\\,720/ih))/2:(720-ih*min(1280/iw\\,720/ih))/2:color=black," +
            "format=yuv420p," + DRAW;

          setLog('Перекодирование видео…');
          await ffmpeg.run(
            '-i','in.mp4',
            '-vf', vf,
            '-c:v','libx264','-preset','veryfast','-crf','23',
            '-c:a','aac','-b:a','128k',
            'out.mp4'
          );

          setLog('Формирование файла…');
          const data = ffmpeg.FS('readFile', 'out.mp4');
          const blob = new Blob([data.buffer], { type: 'video/mp4' });
          const url = URL.createObjectURL(blob);
          $dl.href = url;
          $dl.style.display = 'inline-block';
          setLog('Готово! Скачайте MP4 ниже.');
        } catch (e) {
          console.error(e);
          setErr('Ошибка: ' + (e?.message || e));
          setLog('');
          alert('Произошла ошибка. Попробуйте укоротить видео или обновить Telegram/браузер.');
        } finally {
          $go.disabled = false;
        }
      });
    })();
  </script>

  <noscript>Для работы нужен включённый JavaScript.</noscript>
</body>
</html>
